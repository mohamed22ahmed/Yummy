import{_ as A,ay as w,az as k,u as D,A as o,m as p,n as s,a0 as n,d as i,q as c,b7 as Q,X as C,Y as _,ap as l,a2 as g,$ as O,F as u,a1 as v,p as q,a4 as E,a5 as S,as as h,aQ as V}from"./index.f6661a24.js";import{Q as j}from"./QToolbarTitle.0f4dda99.js";import{Q as x}from"./QSpace.7af5fd36.js";import{Q as z}from"./QToolbar.7bb603c7.js";import{Q as I}from"./QImg.b7890c8b.js";import{Q as F}from"./QItemLabel.0d3c2221.js";import{Q as R}from"./QList.16ddb51a.js";import{u as N}from"./OrderStore.c0aa6efc.js";import{P as M}from"./PrintTemplate.1e180354.js";import{A as m}from"./AppBluetooth.bdfa691f.js";const U={name:"OrderPreview",props:["data","items_details","settings_tabs","order_group_buttons","order_buttons"],components:{NumberFormat:w(()=>k(()=>import("./NumberFormat.5c736195.js"),["assets/NumberFormat.5c736195.js","assets/index.f6661a24.js","assets/index.1593f83d.css"])),RejectionList:w(()=>k(()=>import("./RejectionList.af7eca08.js"),["assets/RejectionList.af7eca08.js","assets/QToolbarTitle.0f4dda99.js","assets/index.f6661a24.js","assets/index.1593f83d.css","assets/QSpace.7af5fd36.js","assets/QToolbar.7bb603c7.js","assets/QItemLabel.0d3c2221.js","assets/QList.16ddb51a.js","assets/QFooter.4f4f9530.js","assets/QResizeObserver.dc10e4c2.js","assets/QForm.4e86ee71.js","assets/ClosePopup.6296f014.js"])),PrinterList:w(()=>k(()=>import("./PrinterList.7567177e.js"),["assets/PrinterList.7567177e.js","assets/index.f6661a24.js","assets/index.1593f83d.css","assets/QToolbarTitle.0f4dda99.js","assets/QSpace.7af5fd36.js","assets/QToolbar.7bb603c7.js","assets/QList.16ddb51a.js","assets/QFooter.4f4f9530.js","assets/QResizeObserver.dc10e4c2.js","assets/ClosePopup.6296f014.js","assets/UserStore.3896d23d.js"])),PrintPreview:w(()=>k(()=>import("./PrintPreview.f376de4c.js"),["assets/PrintPreview.f376de4c.js","assets/QSpace.7af5fd36.js","assets/index.f6661a24.js","assets/index.1593f83d.css","assets/ClosePopup.6296f014.js","assets/PrintTemplate.1e180354.js"]))},data(){return{dialog:!1,modal_rejection:!1,button_uuid:"",method:"",commission:"",printer_details:[]}},setup(){const e=N(),r=D();return{OrderStore:e,DataStore:r}},methods:{changeColor(e){let r="mygrey";switch(e){case"btn-green":r="primary";break;case"btn-yellow":r="yellow-9";break;case"btn-black":r="mygrey";break}return r},changeTextColor(e){let r="white";switch(e){case"btn-green":r="white";break;case"btn-yellow":r="white";break;case"btn-black":r="dark";break}return r},whenShow(){if(this.data.is_view==1)return!1;o.fetchDataByToken("setOrderViewed",{order_uuid:this.data.order_uuid}).then(e=>{}).catch(e=>{}).then(e=>{})},hasMoreButtons(e,r){return e[r]&&e[r].group_name=="order_ready"?!(this.order_group_buttons[e[r].group_name]&&this.order_group_buttons[e[r].group_name][this.data.order_type].length<=2):!1},doActions(e){console.log(e),this.button_uuid=e.uuid,e.do_actions=="reject_form"?this.$refs.rejection.dialog=!0:this.getOrderSummaryChanges(e)},afterAddreason(e){this.dialog=!1,this.updateOrderStatus(e,"updateOrderStatus")},updateOrderStatus(e,r){o.showLoadingBox("",this.$q),o.fetchDataByToken(r,{order_uuid:this.data.order_uuid,reason:e,uuid:this.button_uuid}).then(t=>{this.dialog=!1,this.$emit("afterUpdatestatus")}).catch(t=>{o.notify("dark",t,"error",this.$q)}).then(t=>{o.hideLoadingBox(this.$q)})},getOrderSummaryChanges(e){o.showLoadingBox("",this.$q),o.fetchDataByToken("getOrderSummaryChanges",{order_uuid:this.data.order_uuid,group_name:e.group_name}).then(r=>{this.method=r.details.summary_changes.method,this.commission=r.details.commission,console.log(this.method),this.method=="less_on_account"?this.$q.dialog({title:this.$t("Accept Order"),message:this.commission,cancel:{label:"Cancel","no-caps":!0,flat:!0},persistent:!0,transitionShow:"none",transitionHide:"none",ok:{label:this.$t("Less on my account"),"no-caps":!0,unelevated:!0,class:"radius8"}}).onOk(()=>{this.updateOrderStatus("","lessCashOnAccount")}):(console.log("here"),this.updateOrderStatus("","updateOrderStatus"))}).catch(r=>{o.notify("dark",r,"error",this.$q)}).then(r=>{o.hideLoadingBox(this.$q)})},showPrinter(){this.$q.capacitor?this.DataStore.osVersion>=12?this.$q.platform.is.ios?this.EnabledBT():m.CheckBTConnectPermissionOnly().then(e=>{this.EnabledBT()}).catch(e=>{this.$router.push("/settings/location-enabled")}).then(e=>{}):m.CheckLocationOnly().then(e=>{this.$refs.printer.dialog=!0}).catch(e=>{this.$router.push("/settings/location-enabled")}).then(e=>{}):this.$refs.printer.dialog=!0},EnabledBT(){m.Enabled().then(e=>{this.$refs.printer.dialog=!0}).catch(e=>{o.notify("dark",e.message,"error",this.$q)}).then(e=>{})},afterSelectprinter(e){this.printer_details=e,e.printer_model=="feieyun"?this.FPprint(e):this.$q.capacitor?this.getOrder():o.notify("dark",this.$t("Bluetooth Printers works only in actual device"),"error",this.$q)},async getOrder(){o.showLoadingBox(this.$t("Getting order..."),this.$q);try{let e=await this.OrderStore.orderDetails(this.data.order_uuid);this.$refs.printer.dialog=!1,o.hideLoadingBox(this.$q),this.CheckBT()}catch(e){o.notify("dark",e,"error",this.$q),o.hideLoadingBox(this.$q)}},CheckBT(){m.Enabled().then(e=>{this.DataStore.printer_set==2?this.$refs.print_preview.showDialog(!0,!1):this.BondAndConnect()}).catch(e=>{o.notify("dark",e,"error",this.$q)}).then(e=>{})},BondAndConnect(){this.$refs.printer.dialog=!1,o.showLoadingBox(this.$t("Connecting..."),this.$q),m.Connect(this.printer_details.printer_uuid,this.printer_details.printer_model).then(e=>{this.Print()}).catch(e=>{o.notify("dark",e,"error",this.$q)}).then(e=>{o.hideLoadingBox(this.$q)})},Print(){let e=M.ReceiptTemplate(this.printer_details.paper_width,this.OrderStore.order_info,this.OrderStore.merchant,this.OrderStore.order_items,this.OrderStore.order_summary);console.log("TEMPLATE ==>"),console.log(e.tpl_all),console.log(e.tpl_data),Object.keys(e).length>0&&(this.printer_details.printer_model=="sunmi"?this.printData(e.tpl_all):Object.entries(e.tpl_data).forEach(([r,t])=>{o.empty(t)||(r>0?setTimeout(()=>{console.log(t),this.printData(t)},2e3):(console.log(t),this.printData(t)))}))},printData(e){o.showLoadingBox(this.$t("Printing..."),this.$q),m.Print(this.printer_details.printer_uuid,e,this.printer_details.printer_model,this.printer_details.service_id,this.printer_details.characteristics).then(r=>{}).catch(r=>{o.notify("dark",r,"error",this.$q)}).then(r=>{o.hideLoadingBox(this.$q)})},FPprint(e){this.$refs.printer.dialog=!1,o.showLoadingBox(this.$t("Printing..."),this.$q),o.fetchDataByTokenPost("FPprint","printer_id="+e.printer_id+"&order_uuid="+this.data.order_uuid).then(r=>{o.notify(this.$q.dark.mode?"grey600":"light-green",r.msg,"check",this.$q)}).catch(r=>{o.notify("dark",r,"error",this.$q)}).then(r=>{o.hideLoadingBox(this.$q)})}}},G={class:"text-primary"},H={class:"q-pl-md q-pr-md q-mb-sm"},X={class:"text-right"},Y={class:"font13 text-weight-bold no-margin line-normal"},J={class:"text-grey font11 line-normal"},K={class:"text-strike"},W={class:"font14 text-weight-bold"},Z={class:"row items-center justify-between q-pl-xl q-pt-sm border-grey-top text-weight-bold"};function $(e,r,t,f,y,d){const b=p("NumberFormat"),B=p("RejectionList"),L=p("PrinterList"),P=p("PrintPreview");return s(),n(u,null,[i(V,{modelValue:y.dialog,"onUpdate:modelValue":r[1]||(r[1]=a=>y.dialog=a),position:"bottom",onShow:d.whenShow},{default:c(()=>[i(Q,{class:"rounded-borders-top"},{default:c(()=>[i(z,{class:"text-primary top-toolbar q-pl-md",dense:""},{default:c(()=>[i(j,{class:"text-dark text-weight-bold"},{default:c(()=>[C(_(e.$t("Order"))+" ",1),l("span",G,"#"+_(t.data.order_id_raw),1)]),_:1}),i(x),i(g,{onClick:d.showPrinter,color:"white",square:"",unelevated:"","text-color":"grey",icon:"las la-print",dense:"","no-caps":"",size:"sm",class:"border-grey radius8 q-mr-md"},null,8,["onClick"]),i(g,{onClick:r[0]||(r[0]=a=>y.dialog=!1),color:"white",square:"",unelevated:"","text-color":"grey",icon:"las la-times",dense:"","no-caps":"",size:"sm",class:"border-grey radius8"})]),_:1}),l("div",H,[l("div",X,[i(g,{flat:"",color:e.$q.dark.mode?"secondary":"blue","no-caps":"",label:e.$t("View full order details"),dense:"",size:"md",to:{path:"/orderview",query:{order_uuid:t.data.order_uuid}}},null,8,["color","label","to"])]),i(R,{class:O(["radius8",{"bg-grey600 text-grey300":e.$q.dark.mode,"bg-lightprimary text-black":!e.$q.dark.mode}])},{default:c(()=>[(s(!0),n(u,null,v(t.data.items,a=>(s(),q(E,{key:a},{default:c(()=>[i(S,{avatar:""},{default:c(()=>[i(I,{src:t.items_details[a.item_id].photo,lazy:"",fit:"cover",style:{height:"70px",width:"70px"},class:"radius8","spinner-color":"secondary","spinner-size":"sm","placeholder-src":"placeholder.png"},null,8,["src"])]),_:2},1024),i(S,null,{default:c(()=>[i(F,null,{default:c(()=>[l("div",Y,_(t.items_details[a.item_id].item_name),1),l("div",J,[C(_(a.qty)+" x ",1),a.discount>0?(s(),n(u,{key:0},[l("span",K,[i(b,{amount:1*a.price},null,8,["amount"])]),i(b,{amount:a.price-a.discount},null,8,["amount"])],64)):(s(),q(b,{key:1,amount:1*a.price},null,8,["amount"]))]),l("div",W,[i(b,{amount:a.qty*a.price},null,8,["amount"])])]),_:2},1024)]),_:2},1024)]),_:2},1024))),128))]),_:1},8,["class"]),i(x,{class:"q-pa-sm"}),l("div",Z,[l("div",null,_(e.$t("Total")),1),l("div",null,_(t.data.total),1)]),i(x,{class:"q-pa-xs"}),l("div",{class:O(["q-gutter-sm",{row:!d.hasMoreButtons(t.settings_tabs,t.data.status_raw),column:d.hasMoreButtons(t.settings_tabs,t.data.status_raw)}])},[t.settings_tabs[t.data.status_raw]?(s(),n(u,{key:0},[t.settings_tabs[t.data.status_raw].group_name=="order_ready"?(s(),n(u,{key:0},[t.order_group_buttons[t.settings_tabs[t.data.status_raw].group_name]?(s(),n(u,{key:0},[t.order_group_buttons[t.settings_tabs[t.data.status_raw].group_name][t.data.order_type]?(s(!0),n(u,{key:0},v(t.order_group_buttons[t.settings_tabs[t.data.status_raw].group_name][t.data.order_type],a=>(s(),n("div",{key:a,class:"col"},[t.order_buttons[a]?(s(),n(u,{key:0},[t.data.status_raw.toLowerCase().trim()!=t.order_buttons[a].button_name.toLowerCase().trim()?(s(),q(g,{key:0,size:"lg",unelevated:"",color:d.changeColor(t.order_buttons[a].class_name),"text-color":d.changeTextColor(t.order_buttons[a].class_name),"no-caps":"",label:t.order_buttons[a].button_name,class:"radius8 fit line-1",onClick:T=>d.doActions(t.order_buttons[a])},null,8,["color","text-color","label","onClick"])):h("",!0)],64)):h("",!0)]))),128)):h("",!0)],64)):h("",!0)],64)):(s(),n(u,{key:1},[t.order_group_buttons[t.settings_tabs[t.data.status_raw].group_name]?(s(!0),n(u,{key:0},v(t.order_group_buttons[t.settings_tabs[t.data.status_raw].group_name].none,a=>(s(),n("div",{key:a,class:"col"},[t.order_buttons[a]?(s(),n(u,{key:0},[t.data.status_raw.toLowerCase().trim()!=t.order_buttons[a].button_name.toLowerCase().trim()?(s(),q(g,{key:0,size:"lg",unelevated:"","no-caps":"",label:t.order_buttons[a].button_name,class:"radius8 fit line-1",onClick:T=>d.doActions(t.order_buttons[a]),color:d.changeColor(t.order_buttons[a].class_name),"text-color":d.changeTextColor(t.order_buttons[a].class_name)},null,8,["label","onClick","color","text-color"])):h("",!0)],64)):h("",!0)]))),128)):h("",!0)],64))],64)):h("",!0)],2)])]),_:1})]),_:1},8,["modelValue","onShow"]),i(B,{ref:"rejection",onAfterAddreason:d.afterAddreason},null,8,["onAfterAddreason"]),i(L,{ref:"printer",onAfterSelectprinter:d.afterSelectprinter},null,8,["onAfterSelectprinter"]),i(P,{ref:"print_preview",printer_details:y.printer_details,order_info:f.OrderStore.order_info,merchant:f.OrderStore.merchant,order_items:f.OrderStore.order_items,order_summary:f.OrderStore.order_summary},null,8,["printer_details","order_info","merchant","order_items","order_summary"])],64)}var ue=A(U,[["render",$]]);export{ue as default};
