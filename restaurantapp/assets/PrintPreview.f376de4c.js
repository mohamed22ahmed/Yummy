import{Q as B}from"./QSpace.7af5fd36.js";import{_ as R,u as S,A as h,n as g,p as v,q as f,d as _,b7 as q,b8 as w,a3 as A,a2 as P,ap as T,dc as j,as as L,aQ as Q}from"./index.f6661a24.js";import{C as E}from"./ClosePopup.6296f014.js";import{P as o}from"./PrintTemplate.1e180354.js";let b=0;const p={async ConnectToPrinter(t){return await new Promise(function(s,e){BTPrinter.connect(a=>{b=0,console.log("Connected "+b),s(!0)},a=>{e(a),b<=0&&p.ConnectToPrinter(t),b++},t)})},async DisconnectToPrinter(t){return await new Promise(function(s,e){setTimeout(function(){BTPrinter.disconnect(a=>{console.log("disconnect"),s(!0)},a=>{e(a)},t)},1500)})},async printPOSCommand(t){return await new Promise(function(s,e){BTPrinter.printPOSCommand(a=>{s(!0)},a=>{e(a)},t)})},async printText(t){return await new Promise(function(s,e){BTPrinter.printText(a=>{s(!0)},a=>{e(a)},t)})},async printBase64(t,i){return await new Promise(function(e,a){BTPrinter.printBase64(function(l){e(!0)},function(l){a(l)},t,i)})}},W={name:" PrintPreview",props:["printer_details","order_info","merchant","order_items","order_summary","order_services"],data(){return{dialog:!1,data_info:[],data_items:[],data_summary:[],baseImage:"",auto_print:!1}},setup(){return{DataStore:S()}},computed:{getPaperWidth(){return this.printer_details.paper_width=="80"?this.DataStore.printer_paper_width_80:this.DataStore.printer_paper_width_56}},methods:{PaperWidth(){return this.printer_details.paper_width=="80"?this.DataStore.printer_paper_width_80:this.DataStore.printer_paper_width_56},showDialog(t,i){t&&setTimeout(()=>{this.initData()},100),this.auto_print=i,this.dialog=t},async initData(){this.data_info=[],this.data_items=[],this.data_summary=[];let t=25,i=0,s=this.$refs.receiptCanvas,e=s.getContext("2d");e.clearRect(0,0,s.width,s.height);let a=this.PaperWidth();a=a==585?395:498,console.log("maxLineWidth=>"+a);let l=o.countText(e,this.merchant.restaurant_name,a);i+=l.length,l=o.countText(e,this.merchant.address,a),i+=l.length,this.data_info.push({label:this.$t("Order ID"),value:this.order_info.order_id}),this.data_info.push({label:this.$t("Customer Name"),value:this.order_info.customer_name}),this.data_info.push({label:this.$t("Email"),value:this.order_info.contact_email}),this.data_info.push({label:this.$t("Phone"),value:this.order_info.contact_number}),this.order_info.order_type=="delivery"&&(this.data_info.push({label:this.$t("Address"),value:this.order_info.address1+" "+this.order_info.delivery_address}),this.data_info.push({label:this.$t("Address label"),value:this.order_info.address_label}),i+=2),this.data_info.push({label:this.$t("Order Type"),value:h.empty(this.order_services)?this.order_info.order_type:this.order_services.service_name}),this.data_info.push({label:this.$t("Delivery Date/Time"),value:this.order_info.whento_deliver=="now"?this.order_info.schedule_at:this.order_info.delivery_date+" "+this.order_info.delivery_time}),h.empty(this.merchant.merchant_tax_number)||(this.data_info.push({label:this.$t("Tax number"),value:this.merchant.merchant_tax_number}),i++),i+=17,l=o.countText(e,this.order_info.payment_name,a),i+=l.length,this.order_info.payment_change>0&&i++,this.data_items=[],Object.keys(this.order_items).length>0&&Object.entries(this.order_items).forEach(([k,n])=>{let $=n.price.size_name!=""?"("+n.price.size_name+")":"";this.data_items.push({label:n.qty+" x "+n.item_name+$,value:n.price.discount>0?n.price.pretty_total_after_discount:n.price.pretty_total}),this.data_items.push({label:n.category_name,value:""}),n.special_instructions!=""&&this.data_items.push({label:n.special_instructions,value:""}),n.attributes!=""&&Object.keys(n.attributes).length>0&&Object.entries(n.attributes).forEach(([D,y])=>{Object.entries(y).forEach(([O,u])=>{this.data_items.push({label:u,value:""})})}),Object.keys(n.addons).length>0&&Object.entries(n.addons).forEach(([D,y])=>{this.data_items.push({label:y.subcategory_name,value:""}),Object.entries(y.addon_items).forEach(([O,u])=>{this.data_items.push({label:u.qty+" x "+u.pretty_price+" "+u.sub_item_name,value:u.pretty_addons_total})})})}),Object.keys(this.order_summary).length>0&&Object.entries(this.order_summary).forEach(([k,n])=>{this.data_summary.push({label:n.name,value:n.value})}),i++,l=o.countText(e,"************ THANK YOU ************",a),i+=l.length;let m=t,c=0;c=await o.TableColumnCount(e,this.data_items,a,m,t),console.log("items count_data =>"+c),i+=c+2,c=await o.TableColumnCount(e,this.data_summary,a,m,t),console.log("data_summary count_data =>"+c),i+=c+1,console.log("itemCount=>"+i);let C=t*i;s.height=C;let d;e.fillStyle="#ffffff",e.fillRect(0,0,s.width,s.height),e.strokeStyle="#000000",e.lineWidth=1,e.fillStyle="#000000",e.font="300 24px Arial";let r=t;o.centerText(e,this.merchant.restaurant_name,r,a,t),r+=t,o.centerText(e,this.merchant.address,r,a,t),r+=t+15,o.drawLine(e,a,r),r+=t,d=await o.TableColumn(e,this.data_info,a,r,t),r+=t*d,r+=t,e.textAlign="left",o.longText(e,this.order_info.payment_name,r,a,t),r+=t,e.fillText(`
`,0,r),o.drawLine(e,a,r),r+=10,d=await o.TableColumn(e,this.data_items,a,r,t),console.log("Items data_lenght =>"+d),r+=t*d+15,e.fillText(`
`,0,r),o.drawLine(e,a,r),r+=t,d=await o.TableColumn(e,this.data_summary,a,r,t),r+=t*d+15,e.textAlign="left",e.fillText(`
`,0,r),o.drawLine(e,a,r),r+=t,r+=t,r+=t;let x=this.$t("THANK YOU");o.centerText(e,"******** "+x+" ********",r,a,t),this.baseImage=s.toDataURL("image/png"),this.auto_print&&this.PrintReceipt()},PrintReceipt(){if(!this.$q.capacitor)return h.notify("dark",this.$t("Bluetooth printer only works in actual device"),"error",this.$q),!1;if(h.empty(this.printer_details.printer_bt_name))return h.notify("dark",this.$t("Printer has no printer name please remove this printer and add again"),"error",this.$q),!1;console.log(this.printer_details.printer_bt_name),h.showLoadingBox("",this.$q),p.ConnectToPrinter(this.printer_details.printer_bt_name).then(t=>{p.printPOSCommand("0A"),p.printPOSCommand("1B6100"),p.printBase64(this.baseImage,0).then(i=>{this.auto_print&&(this.dialog=!1)}).catch(i=>{h.notify("dark",i,"error",this.$q),this.dialog=!1}).then(i=>{}),this.DataStore.printer_auto_close&&this.disConnect()}).catch(t=>{h.notify("dark",t,"error",this.$q),this.dialog=!1}).then(t=>{h.hideLoadingBox(this.$q)})},disConnect(){p.DisconnectToPrinter(this.printer_details.printer_bt_name).then(t=>{this.auto_print&&(this.dialog=!1)}).catch(t=>{h.notify("dark",t,"error",this.$q)}).then(t=>{})}}},I={class:"canvas-container"},V=["width"];function N(t,i,s,e,a,l){return g(),v(Q,{modelValue:a.dialog,"onUpdate:modelValue":i[0]||(i[0]=m=>a.dialog=m),"full-width":"","full-height":""},{default:f(()=>[_(q,null,{default:f(()=>[_(w,{class:"row items-center q-pb-none"},{default:f(()=>[_(B),A(_(P,{icon:"close",flat:"",round:"",dense:""},null,512),[[E]])]),_:1}),_(w,null,{default:f(()=>[T("div",I,[T("canvas",{class:"receiptCanvas",ref:"receiptCanvas",width:l.getPaperWidth,height:"100"},null,8,V)])]),_:1}),a.auto_print?L("",!0):(g(),v(j,{key:0},{default:f(()=>[_(P,{label:t.$t("Print Receipt"),"no-caps":"",unelevated:"",color:"primary",size:"lg",class:"fit",onClick:l.PrintReceipt},null,8,["label","onClick"])]),_:1}))]),_:1})]),_:1},8,["modelValue"])}var K=R(W,[["render",N]]);export{K as default};
