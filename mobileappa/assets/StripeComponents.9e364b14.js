import{Q as p}from"./QSpace.5a38bd33.js";import{_,m as i,p as u,q as y,s as o,f as s,X as h,a8 as f,S as l,Y as m,aX as b,b1 as g,bD as w,a7 as S,aA as $}from"./index.4c3eb750.js";import{Q as v}from"./QToolbar.45531803.js";import{Q as q}from"./QInnerLoading.488297dd.js";import{Q as C}from"./QForm.ce1b13be.js";const k={name:"StripeComponents",props:["title","label","payment_code","payment_credentials"],data(){return{show_modal:!1,data:[],loading:!1,visible:!1,client_secret:"",customer_id:"",publish_key:"",stripe:void 0,cardElement:void 0,cardholder_name:"",merchant_id:"",merchant_type:""}},methods:{showPaymentForm(){this.show_modal=!0,this.createCustomer()},close(){this.show_modal=!1},createCustomer(){typeof this.payment_credentials[this.payment_code]!="undefined"&&this.payment_credentials[this.payment_code]!==null&&(this.merchant_id=this.payment_credentials[this.payment_code].merchant_id,this.merchant_type=this.payment_credentials[this.payment_code].merchant_type);const t={merchant_id:this.merchant_id,payment_code:this.payment_code,merchant_type:this.merchant_type,reference:""};this.loading=!0,this.visible=!0,i.StripeCreateCustomer(t).then(e=>{this.client_secret=e.details.client_secret,this.customer_id=e.details.customer_id,this.initStripe()}).catch(e=>{i.notify("dark",e,"error",this.$q)}).then(e=>{this.loading=!1,this.visible=!1})},initStripe(){window.Stripe==null?new Promise(t=>{const e=window.document,a="stripe-script",d=e.createElement("script");d.id=a,d.setAttribute("src","https://js.stripe.com/v3/"),e.head.appendChild(d),d.onload=()=>{t()}}).then(()=>{this.renderCard()}):this.renderCard()},renderCard(){const t={base:{color:"#32325d",fontFamily:'"Helvetica Neue", Helvetica, sans-serif',fontSmoothing:"antialiased",fontSize:"16px","::placeholder":{color:"#aab7c4"}},invalid:{color:"#fa755a",iconColor:"#fa755a"}};if(typeof this.payment_credentials[this.payment_code]!="undefined"&&this.payment_credentials[this.payment_code]!==null){this.publish_key=this.payment_credentials[this.payment_code].attr2,this.stripe=Stripe(this.publish_key);const e=this.stripe.elements();this.cardElement=e.create("card",{style:t}),setTimeout(()=>{this.cardElement.mount(this.$refs.card_element)},500)}else i.notify("dark","invalid payment credentials","warning",this.$q)},onSubmit(){this.loading=!0,this.visible=!0,this.stripe.confirmCardSetup(this.client_secret,{payment_method:{card:this.cardElement,billing_details:{name:this.cardholder_name}}}).then(t=>{this.loading=!1,this.visible=!1,t.error?t.error.code==="setup_intent_unexpected_state"&&this.createIntent():this.savePayment(t.setupIntent.payment_method)})},savePayment(t){this.loading=!0;const e={payment_method_id:t,merchant_id:this.merchant_id,payment_code:this.payment_code,merchant_type:this.merchant_type,reference:this.reference};i.StripeSavePayment(e).then(a=>{this.close(),this.$emit("afterAddpayment")}).catch(a=>{i.notify("dark",a,"error",this.$q)}).then(a=>{this.loading=!1})},createIntent(){const t={customer_id:this.customer_id,merchant_id:this.merchant_id,payment_code:this.payment_code,merchant_type:this.merchant_type};i.StripeCreateIntent(t).then(e=>{this.close(),this.$emit("afterAddpayment")}).catch(e=>{i.notify("dark",e,"error",this.$q)}).then(e=>{this.loading=!1})},PaymentRender(t){const e={cart_uuid:t.cart_uuid,order_uuid:t.order_uuid,payment_uuid:t.payment_uuid,payment_code:t.payment_code};i.showLoadingBox(this.$t("Processing payment")+"<br/>"+this.$t("don't close this window"),this.$q),i.StripePaymentIntent(e).then(a=>{this.$emit("afterPayment",a.details)}).catch(a=>{i.notify("dark",a,"error",this.$q)}).then(a=>{i.hideLoadingBox(this.$q)})},Dopayment(t){i.showLoadingBox(this.$t("Processing payment")+"<br/>"+this.$t("don't close this window"),this.$q),i.fetchDataByTokenPostPayment("StripeProcesspayment",{data:t}).then(e=>{this.$emit("afterSuccessfulpayment",e.details)}).catch(e=>{i.notify("dark",e,"error",this.$q)}).then(e=>{i.hideLoadingBox(this.$q)})}}},Q={class:"text-weight-bold no-margin"},P={class:"q-ma-sm"},x={class:"font12"},I={class:"q-mb-md",ref:"card_element"},B={class:"font11"};function V(t,e,a,d,n,c){return u(),y($,{modelValue:n.show_modal,"onUpdate:modelValue":e[2]||(e[2]=r=>n.show_modal=r),persistent:"","transition-show":"fade","transition-hide":"fade"},{default:o(()=>[s(S,{style:{width:"500px","max-width":"80vw"}},{default:o(()=>[s(v,{class:"text-primary top-toolbar q-pl-md",dense:""},{default:o(()=>[s(p),s(h,{onClick:e[0]||(e[0]=r=>n.show_modal=!1),color:"white",square:"",unelevated:"","text-color":"grey",icon:"las la-times",dense:"","no-caps":"",size:"sm",class:"border-grey radius8"})]),_:1}),s(C,{onSubmit:c.onSubmit},{default:o(()=>[s(f,{class:"q-pa-md",style:{"padding-bottom":"0px"}},{default:o(()=>[l("h5",Q,m(a.title),1),l("div",P,[l("p",x,m(a.label.notes),1)]),s(b,{dense:"","bg-color":t.$q.dark.mode?"grey600":"mygrey",color:t.$q.dark.mode?"grey300":"primary",outlined:"",modelValue:n.cardholder_name,"onUpdate:modelValue":e[1]||(e[1]=r=>n.cardholder_name=r),rules:[r=>r&&r.length>0||"this field is required"],label:t.$t("Cardholder name")},null,8,["bg-color","color","modelValue","rules","label"]),l("div",I,null,512),l("p",B,m(t.$t("I authorise to send instructions to the financial"))+" "+m(t.$t("institution that issued my card to take payments from my card"))+" "+m(t.$t("account in accordance with the terms of my agreement")),1),s(q,{showing:n.visible,"label-style":"font-size: 1.1em"},null,8,["showing"])]),_:1}),s(g,{spaced:""}),s(w,null,{default:o(()=>[s(h,{type:"submit",label:a.label.submit,loading:n.loading,unelevated:"","no-caps":"",color:"primary text-white",class:"full-width text-weight-bold",size:"lg"},null,8,["label","loading"])]),_:1})]),_:1},8,["onSubmit"])]),_:1})]),_:1},8,["modelValue"])}var T=_(k,[["render",V]]);export{T as default};
