import{_ as R,l as T,av as V,m as b,n as O,p as o,q as f,s as r,f as i,X as S,a5 as m,Y as n,a6 as B,S as q,U as u,az as _,V as A,F as y,t as P,ab as N,ac as L,ad as z}from"./index.4c3eb750.js";import{Q as F}from"./QToolbarTitle.eef0f00f.js";import{Q as W}from"./QToolbar.45531803.js";import{Q as H}from"./QHeader.d51d9950.js";import{Q as X}from"./QSpace.5a38bd33.js";import{Q as D}from"./QItemLabel.cc035d74.js";import{Q as Y}from"./QList.5b181e45.js";import{Q as G}from"./QPageScroller.62333d8f.js";import{Q as J}from"./QPage.959871c7.js";import{Q as K}from"./QPullToRefresh.1e0c7d6e.js";import{c as v,f as C,b as p,q as w,w as Q,o as I,l as U,h as M,g as j}from"./FirebaseChat.bc197042.js";import{d as Z}from"./date.f1276507.js";import"./QResizeObserver.4d611c44.js";import"./use-page-sticky.9d6b41d8.js";import"./touch.9135741d.js";import"./selection.1ed6461a.js";import"./format.8ac60962.js";const $={name:"ChatMain",components:{ChatSearch:T(()=>P(()=>import("./ChatSearch.3f3cb31e.js"),["assets/ChatSearch.3f3cb31e.js","assets/index.4c3eb750.js","assets/index.4784a50d.css","assets/QSpace.5a38bd33.js","assets/QToolbar.45531803.js","assets/ClosePopup.d9033651.js","assets/FirebaseChat.bc197042.js"])),ChatUserLoader:T(()=>P(()=>import("./ChatUserLoader.27e56135.js"),["assets/ChatUserLoader.27e56135.js","assets/QSkeleton.d3c12595.js","assets/index.4c3eb750.js","assets/index.4784a50d.css","assets/QItemLabel.cc035d74.js","assets/QList.5b181e45.js"]))},data(){return{user_uuid:"",data:[],users:[],all_users:[],users_data:[],loading:!1,loading_user:!1,last_message_data:{},whoistyping_data:{},document_id:"",main_user_type:"",refresh_page:void 0}},mounted(){let e=V.getUser();this.user_uuid=e.client_uuid,this.getParticipants()},computed:{getData(){return this.data},getLastMessageData(){return this.last_message_data},hasData(){return Object.keys(this.data).length>0},hasUserData(){return Object.keys(this.users_data).length>0},getShowistyping(){return this.whoistyping_data}},methods:{refresh(e){this.refresh_page=e,this.getParticipants()},getParticipants(){try{this.loading=!0;const e=v(C,p.chats),l=w(e,Q("participants","array-contains",this.user_uuid),I("lastUpdated","desc"),U(p.limit)),k=M(l,c=>{this.data=[],this.users=[],this.all_users=[],this.loading=!1,b.empty(this.refresh_page)||this.refresh_page(),c.forEach(s=>{let a=s.data(),h=a.isTyping||null,d=a.participants||null;if(d){Object.keys(d).length>0&&Object.entries(d).forEach(([E,x])=>{this.all_users.push(x)});let t=d.filter(E=>!E.includes(this.user_uuid)),g=t[0]?t[0]:null;this.users.push(g),this.data.push({doc_id:s.id,user_uuid:g,is_typing:h[t[0]]?h[t[0]]:!1,orderID:a.orderID||null,orderUuid:a.orderUuid||null})}}),Object.keys(this.users).length>0&&(this.getUser(),this.getLastMessage(),this.getWhoIsTyping())},c=>{this.loading=!1,b.empty(this.refresh_page)||this.refresh_page(),console.log("Error fetching chat documents:",c)})}catch(e){b.notify("dark",e,"error",this.$q)}},showSearch(){this.$refs.chat_search.dialog=!0},loadConversation(e){this.$router.push({path:"/account/chat/conversation",query:{doc_id:e}})},getUser(){this.loading_user=!0,b.fetchDataChats("getUsers",{main_user_type:this.main_user_type,users:this.users}).then(e=>{this.users_data=e.details}).catch(e=>{this.users_data=[]}).then(e=>{this.loading_user=!1})},async getLastMessage(){try{const e=this.all_users.splice(0,10),l=v(C,p.chats);(await j(w(l,Q("participants","array-contains-any",this.users)))).forEach(async c=>{const s=c.id,a=v(C,p.chats,s,"messages");(await j(w(a,Q("senderID","in",e),I("timestamp","desc"),U(1)))).forEach(d=>{let t=d.data(),g=t.timestamp.toDate().toISOString();this.last_message_data[s]={message:t.message,timestamp:g,time:Z.formatDate(g,"hh:mm a")}})})}catch(e){console.error("Error fetching last message:",e)}},async getWhoIsTyping(){const e=w(v(C,p.chats),Q("participants","array-contains-any",this.users),I("lastUpdated","desc"),U(p.limit));M(e,l=>{l.forEach(k=>{let s=k.data().isTyping||[];Object.keys(s).length>0&&Object.entries(s).forEach(([a,h])=>{this.whoistyping_data[a]=h})})})},isTyping(e){return Object.keys(this.whoistyping_data).length>0&&this.whoistyping_data[e]||!1}}},ee={class:"q-pl-md q-pr-md"},te={class:"border-grey bg-grey-1 radius8"},ae={key:0,class:"text-body2 text-weight-medium flex flex-center text-grey",style:{height:"calc(80vh)"}},se=["src"],re={key:0,class:"text-primary"},ie={key:0,class:"time"};function oe(e,l,k,c,s,a){const h=O("ChatUserLoader"),d=O("ChatSearch");return o(),f(K,{onRefresh:a.refresh},{default:r(()=>[i(H,{reveal:"","reveal-offset":"20",class:B({"bg-mydark text-white":e.$q.dark.mode,"bg-white text-dark":!e.$q.dark.mode})},{default:r(()=>[i(W,null,{default:r(()=>[i(S,{onClick:l[0]||(l[0]=t=>e.$router.back()),flat:"",round:"",dense:"",icon:"las la-angle-left",class:"q-mr-sm",color:e.$q.dark.mode?"white":"dark"},null,8,["color"]),i(F,{class:"text-weight-bold"},{default:r(()=>[m(n(e.$t("Live Chat")),1)]),_:1})]),_:1})]),_:1},8,["class"]),i(J,null,{default:r(()=>[q("div",ee,[q("div",te,[i(S,{label:e.$t("Search restaurants"),"no-caps":"",color:e.$q.dark.mode?"grey600":"grey-1","text-color":e.$q.dark.mode?"grey300":"grey",icon:"search",unelevated:"",align:"left",class:"fit radius8",onClick:a.showSearch},null,8,["label","color","text-color","onClick"])])]),i(X,{class:"q-pa-sm"}),!a.hasData&&!s.loading?(o(),u("div",ae,n(e.$t("Search to chat with restaurants")),1)):_("",!0),s.loading?(o(),f(h,{key:1,rows:10})):_("",!0),a.hasData&&!s.loading&&a.hasUserData?(o(),f(Y,{key:2},{default:r(()=>[(o(!0),u(y,null,A(a.getData,t=>(o(),u(y,{key:t},[s.users_data[t.user_uuid]?(o(),f(N,{key:0,clickable:"",onClick:g=>a.loadConversation(t.doc_id)},{default:r(()=>[i(L,{avatar:""},{default:r(()=>[i(z,null,{default:r(()=>[q("img",{src:s.users_data[t.user_uuid].photo_url},null,8,se)]),_:2},1024)]),_:2},1024),i(L,null,{default:r(()=>[i(D,{class:"text-weight-bold"},{default:r(()=>[m(n(s.users_data[t.user_uuid].first_name)+" "+n(s.users_data[t.user_uuid].last_name),1)]),_:2},1024),i(D,{caption:""},{default:r(()=>[t.orderID?(o(),u(y,{key:0},[m(n(e.$t("Order#"))+" "+n(t.orderID),1)],64)):(o(),u(y,{key:1},[m(n(s.users_data[t.user_uuid].user_type),1)],64))]),_:2},1024),a.getLastMessageData[t.doc_id]?(o(),f(D,{key:0,caption:"",lines:"2"},{default:r(()=>[a.isTyping(t.user_uuid)?(o(),u("span",re,n(s.users_data[t.user_uuid].first_name)+" is typing ...",1)):(o(),u(y,{key:1},[m(n(a.getLastMessageData[t.doc_id].message),1)],64))]),_:2},1024)):_("",!0)]),_:2},1024),i(L,{side:""},{default:r(()=>[i(D,{caption:"",lines:"2",class:"text-center"},{default:r(()=>[a.getLastMessageData[t.doc_id]?(o(),u("div",ie,n(a.getLastMessageData[t.doc_id].time),1)):_("",!0)]),_:2},1024)]),_:2},1024)]),_:2},1032,["onClick"])):_("",!0)],64))),128))]),_:1})):_("",!0),a.hasData&&!s.loading&&a.hasUserData?(o(),f(G,{key:3,position:"bottom-right","scroll-offset":150,offset:[18,18]},{default:r(()=>[i(S,{fab:"",icon:"keyboard_arrow_up",color:"primary",padding:"sm"})]),_:1})):_("",!0)]),_:1}),i(d,{ref:"chat_search"},null,512)]),_:1},8,["onRefresh"])}var we=R($,[["render",oe]]);export{we as default};
